{{/* Expansions Section - All guides except scrum-guide-expanded */}}
{{- $expansionSections := where .Site.Sections "Type" "guide" }}
{{- range .Site.Home.Translations }}
  {{- $expansionSections = $expansionSections | lang.Merge .Site.Sections }}
{{- end }}
{{/* Exclude scrum-guide-expanded from expansions */}}
{{- $filtered := slice }}
{{- range $expansionSections }}
  {{- $isExpansion := partial "functions/is-expansion.html" . }}
  {{- if $isExpansion }}
    {{- $filtered = $filtered | append . }}
  {{- end }}
{{- end }}
{{- $expansionSections = $filtered }}

{{/* If this is a category or tag page, filter expansions by the current term */}}
{{- if eq .Kind "term" }}
  {{- $currentTerm := .Data.Term }}
  {{- if eq .Data.Singular "category" }}
    {{- $expansionSections = where $expansionSections "Params.categories" "intersect" (slice $currentTerm) }}
  {{- else if eq .Data.Singular "tag" }}
    {{- $expansionSections = where $expansionSections "Params.tags" "intersect" (slice $currentTerm) }}
  {{- end }}
{{- end }}
{{- if gt (len $expansionSections) 0 }}
  <div class="mb-5">
    <div class="d-flex align-items-center gap-3 mb-4">
      <span class="bg-primary rounded-pill" style="width: 0.375rem; height: 2rem;"></span>
      <h2 class="h3 mb-0">{{ i18n "extensions_section_title" | default "Expansions" }}</h2>
      <span class="text-muted">({{ len $expansionSections }} {{ i18n "documents" | default "documents" }})</span>
    </div>

    <div class="row g-4">
      {{- range $expansionSections.ByWeight }}
        <div class="col-12 col-md-6 col-lg-4">
          <a href="{{ .RelPermalink }}" class="text-decoration-none">
            <div class="card h-100 border-0 shadow-sm hover-lift">
              <div class="position-absolute top-0 start-0 w-100 h-100 bg-gradient-primary opacity-0 hover-opacity-10 rounded"></div>
              <div class="card-body p-4 position-relative d-flex flex-column">
                <div class="mb-4">
                  <div class="p-3 rounded bg-primary bg-opacity-10 text-primary d-inline-block">
                    <i class="fa-solid fa-file-text fa-lg"></i>
                  </div>
                </div>
                <h3 class="h5 fw-bold mb-3 text-dark hover-text-primary">{{ .Params.short_title | default .Title }}</h3>
                <p class="text-muted small mb-4 line-clamp-3">{{ .Params.Description | markdownify }}</p>

                {{/* Check if content is only in English */}}
                {{- $defaultSite := index $.Site.Sites 0 }}
                {{- if ne $.Site.Language.Lang $defaultSite.Language.Lang }}
                  {{- $showEnglishOnly := false }}
                  {{- if not .Translations }}
                    {{- $showEnglishOnly = true }}
                  {{- else if eq (trim .Content " \n\t") "" }}
                    {{- $showEnglishOnly = true }}
                  {{- end }}
                  {{- if $showEnglishOnly }}
                    <div class="mb-3">
                      <span class="badge border border-warning text-warning bg-transparent" title="This content is only available in English"><i class="fa-solid fa-language me-1"></i>English Only</span>
                    </div>
                  {{- end }}
                {{- end }}

 <div class="d-flex flex-wrap gap-2 mb-4">
                {{/* Categories/Tags */}}
                {{- if .Params.categories }}
                    {{- range .Params.categories }}
                      <span class="badge bg-secondary bg-opacity-50">{{ . | title }}</span>
                    {{- end }}
                {{- end }}
                {{/* Badges: excluded from production / preview based on cascade rules */}}
              {{- $cascade := .Param "cascade" -}}
              {{- with $cascade -}}
                {{- range . -}}
                  {{- $env := .target.environment -}}
                  {{- $renderNever := eq .build.render "never" -}}
                  {{- $listNever := eq .build.list "never" -}}
                  {{- if and (eq $env "production") (or $renderNever $listNever) -}}
                    <span class="badge bg-danger" title="Will not be built in production">
                      <i class="fa-solid fa-eye-slash me-1"></i>Production
                    </span>
                  {{- end -}}
                  {{- if and (eq $env "preview") (or $renderNever $listNever) -}}
                    <span class="badge bg-warning text-dark" title="Will not be built in preview">
                      <i class="fa-solid fa-eye-slash me-1"></i>Preview
                    </span>
                  {{- end -}}
                {{- end -}}
              {{- end -}}
              </div>
                {{/* Contributors - Light List */}}
                {{ partial "components/guide/guide-contributors-with-icon.html" (dict "context" . "roles" (slice "contributor" "creator" "reviewer") "lightList" true) }}


                <div class="d-flex align-items-center justify-content-between pt-3 border-top mt-auto">
                  <div class="d-flex align-items-center gap-2 text-muted small">
                    <i class="fa-solid fa-clock"></i>
                    {{- $allVersions := partial "functions/get-all-versions" . -}}
                    {{- if gt (len $allVersions) 0 }}
                      {{- $latestVersionObj := index $allVersions 0 }}
                      {{- with $latestVersionObj.page }}
                        <span>{{ .ReadingTime }} min read</span>
                      {{- end }}
                    {{- else }}
                      <span>15 min read</span>
                    {{- end }}
                  </div>
                  <i class="fa-solid fa-arrow-right text-primary"></i>
                </div>
              </div>
            </div>
          </a>
        </div>
      {{- end }}
    </div>
  </div>
{{- end }}
