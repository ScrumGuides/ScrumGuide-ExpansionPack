{{/* Core Guide Section - Hard-coded to scrum-guide-expanded only */}}
{{- $coreGuideSection := .Site.GetPage "/scrum-guide-expanded" }}
{{- if $coreGuideSection }}
  {{/* Get all versions and find the latest one */}}
  {{- $allVersions := partial "functions/get-all-versions" $coreGuideSection }}
  {{- $coreGuide := "" }}
  {{- $linkToPage := "" }}
  
  {{/* Find the latest version page (should be first in the list) */}}
  {{- $latestVersionNumber := "" }}
  {{- $linkUrl := "" }}
  {{- if gt (len $allVersions) 0 }}
    {{- $latestVersionObj := index $allVersions 0 }}
    {{- $coreGuide = $latestVersionObj.page }}
    {{- $linkToPage = $coreGuide }}
    {{- $latestVersionNumber = $latestVersionObj.version }}
    
    {{/* Check if latest version has content */}}
    {{- $hasContent := gt $coreGuide.WordCount 10 }}
    {{- $isLatest := true }}
    
    {{/* If current version has no content, find the latest version with content to link to */}}
    {{- if not $hasContent }}
      {{- range $allVersions }}
        {{- if gt .page.WordCount 10 }}
          {{- $linkToPage = .page }}
          {{- $isLatest = false }}
          {{- break }}
        {{- end }}
      {{- end }}
    {{- end }}
    
    {{/* Use section root URL for latest version, versioned URL for older versions */}}
    {{- if $isLatest }}
      {{- $linkUrl = $coreGuideSection.RelPermalink }}
    {{- else }}
      {{- $linkUrl = $linkToPage.RelPermalink }}
    {{- end }}
  {{- end }}
  
  {{- if $linkToPage }}
  
  <div class="mb-5 pb-4">
    <div class="d-flex align-items-center gap-3 mb-4">
      <span class="bg-primary rounded-pill" style="width: 0.375rem; height: 2rem;"></span>
      <h2 class="h3 mb-0">{{ i18n "core_section_title" | default "Scrum Guide Expansion" }}</h2>
    </div>

    <div class="row g-4">
      <div class="col-12">
        <a href="{{ $linkUrl }}" class="text-decoration-none">
          <div class="card h-100 border-2 border-primary shadow-sm hover-lift">
            <div class="position-absolute top-0 start-0 w-100 h-100 bg-gradient-primary opacity-0 hover-opacity-10 rounded"></div>
            <div class="card-body p-4 p-lg-5 position-relative d-flex flex-column">
              <div class="d-flex align-items-start justify-content-between mb-3">
                <div class="p-3 rounded bg-primary text-white">
                  <i class="fa-solid fa-file-text fa-lg"></i>
                </div>
                <span class="badge bg-primary text-white border border-primary">{{ i18n "core_document_badge" | default "Core Document" }}</span>
               

              </div>

              <h3 class="h4 fw-bold text-primary mb-3 hover-text-primary">{{ $coreGuide.Params.short_title | default $coreGuide.Title }}</h3>

              {{/* Check if content is only in English or if there's a newer English version */}}
              {{- $defaultSite := index $.Site.Sites 0 }}
              {{- if ne $.Site.Language.Lang $defaultSite.Language.Lang }}
                {{- $showEnglishOnly := false }}
                {{- $showNewerEnglishVersion := false }}
                {{- $hasContent := gt $coreGuide.WordCount 10 }}
                
                {{/* If current version has no content, we already found the version with content above */}}
                {{- if not $hasContent }}
                  {{- if ne $linkToPage $coreGuide }}
                    {{/* We're linking to an older version, so check if English has a newer version */}}
                    {{- $englishGuide := $defaultSite.GetPage $coreGuideSection.Section }}
                    {{- if $englishGuide }}
                      {{- $englishVersions := partial "functions/get-all-versions" $englishGuide }}
                      {{- if gt (len $englishVersions) 0 }}
                        {{- $englishLatestObj := index $englishVersions 0 }}
                        {{- $englishLatest := $englishLatestObj.version }}
                        {{- $translationVersion := "" }}
                        {{- $pathParts := split $linkToPage.RelPermalink "/" }}
                        {{- range $pathParts }}
                          {{- if and (ne . "") (findRE `^\d{4}\.\d+$` .) }}
                            {{- $translationVersion = . }}
                            {{- break }}
                          {{- end }}
                        {{- end }}
                        {{- if and $englishLatest $translationVersion (ne $translationVersion $englishLatest) }}
                          {{- $showNewerEnglishVersion = true }}
                        {{- end }}
                      {{- end }}
                    {{- end }}
                  {{- else }}
                    {{/* No translation with content exists at all */}}
                    {{- $showEnglishOnly = true }}
                  {{- end }}
                {{- end }}
                
                {{- if $showEnglishOnly }}
                  <div class="mb-3">
                    <span class="badge border border-warning text-warning bg-transparent" title="This content is only available in English"><i class="fa-solid fa-language me-1"></i>English Only</span>
                  </div>
                {{- else if $showNewerEnglishVersion }}
                  <div class="mb-3">
                    <span class="badge border border-info text-info bg-transparent" title="A newer version is available in English"><i class="fa-solid fa-clock me-1"></i>Newer English Version Available</span>
                  </div>
                {{- end }}
              {{- end }}

              <div class="d-flex flex-wrap gap-2 mb-4">
                {{/* Categories/Tags */}}
                {{- if $coreGuide.Params.categories }}
                    {{- range $coreGuide.Params.categories }}
                      <span class="badge bg-secondary bg-opacity-50">{{ . | title }}</span>
                    {{- end }}
                {{- end }}
                {{/* Badges: excluded from production / preview based on cascade rules */}}
              {{- $cascade := $coreGuide.Param "cascade" -}}
              {{- with $cascade -}}
                {{- range . -}}
                  {{- $env := .target.environment -}}
                  {{- $renderNever := eq .build.render "never" -}}
                  {{- $listNever := eq .build.list "never" -}}
                  {{- if and (eq $env "production") (or $renderNever $listNever) -}}
                    <span class="badge bg-danger" title="Will not be built in production">
                      <i class="fa-solid fa-eye-slash me-1"></i>Production
                    </span>
                  {{- end -}}
                  {{- if and (eq $env "preview") (or $renderNever $listNever) -}}
                    <span class="badge bg-warning text-dark" title="Will not be built in preview">
                      <i class="fa-solid fa-eye-slash me-1"></i>Preview
                    </span>
                  {{- end -}}
                {{- end -}}
              {{- end -}}
              {{/* Version count badge */}}
              {{- if gt (len $allVersions) 1 }}
                <span class="badge bg-info bg-opacity-75" title="{{ len $allVersions }} versions available">
                  <i class="fa-solid fa-code-branch me-1"></i>{{ len $allVersions }} versions
                </span>
              {{- end }}
              </div>

              <p class="text-muted mb-4">{{ $coreGuide.Params.description | markdownify }}</p>

              {{/* Contributors - Light List */}}
              {{ partial "components/guide/guide-contributors-with-icon.html" (dict "context" $coreGuide "roles" (slice "contributor" "creator" "reviewer") "lightList" true) }}


              <div class="d-flex align-items-center justify-content-between pt-3 border-top mt-auto">
                <div class="d-flex align-items-center gap-2 text-muted small">
                  <i class="fa-solid fa-clock"></i>
                  {{- if $linkToPage }}
                    <span>{{ $linkToPage.ReadingTime }} min read</span>
                  {{- else }}
                    <span>15 min read</span>
                  {{- end }}
                </div>
                <i class="fa-solid fa-arrow-right text-primary"></i>
              </div>
            </div>
          </div>
        </a>
      </div>
    </div>
  </div>
  {{- end }}
{{- end }}
