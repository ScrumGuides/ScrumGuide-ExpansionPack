{{/* Category Filter List */}}
<div class="mb-5">
  <div class="d-flex flex-wrap justify-content-center gap-2" id="category-list-container">
    {{/* All button (Homepage link) */}}
    <a href="{{ .Site.Home.RelPermalink }}" class="btn {{ if .IsHome }}btn-primary{{ else }}btn-outline-primary{{ end }}">
      <i class="fa-solid fa-grid-2 me-2"></i>
      {{ i18n "all_topics" | default "All" }}
    </a>

    {{/* Build a sorted list of categories by extensions count */}}
    {{- $categoryList := slice }}
    {{- $allCategories := dict }}
    {{- $defaultSite := index .Site.Sites 0 }}
    {{- $currentLangCategories := .Site.Taxonomies.categories }}

    {{/* Always merge categories from default language to show untranslated categories */}}
    {{- range $categoryName, $taxonomy := $defaultSite.Taxonomies.categories }}
      {{- $allCategories = merge $allCategories (dict $categoryName $taxonomy) }}
    {{- end }}
    {{/* Then merge current language categories (they override default if they exist) */}}
    {{- range $categoryName, $taxonomy := .Site.Taxonomies.categories }}
      {{- $allCategories = merge $allCategories (dict $categoryName $taxonomy) }}
    {{- end }}

    {{- range $categoryName, $taxonomy := $allCategories }}
      {{/* Count only pages that are expansions (guides except scrum-guide-expanded) */}}
      {{- $expansionsCount := 0 }}
      {{- range $taxonomy.Pages }}
        {{- $isExpansion := partial "functions/is-expansion.html" . }}
        {{- if $isExpansion }}
          {{- $expansionsCount = add $expansionsCount 1 }}
        {{- end }}
      {{- end }}
      {{- if gt $expansionsCount 0 }}
        {{/* Check if this category is from English (not in current language) */}}
        {{- $isEnglishCategory := false }}
        {{- if ne $.Site.Language.Lang $defaultSite.Language.Lang }}
          {{- if not (index $currentLangCategories $categoryName) }}
            {{- $isEnglishCategory = true }}
          {{- end }}
        {{- end }}
        {{- $categoryList = $categoryList | append (dict "Page" $taxonomy.Page "CategoryName" $categoryName "Count" $expansionsCount "IsEnglish" $isEnglishCategory) }}
      {{- end }}
    {{- end }}

    {{/* Sort by count descending */}}
    {{- $sortedCategories := sort $categoryList "Count" "desc" }}
    {{- $hasHiddenCategories := false }}
    {{- range $index, $category := $sortedCategories }}
      {{/* Construct category URL - fallback to manual construction if page doesn't exist */}}
      {{- $categoryURL := "" }}
      {{- if $category.Page }}
        {{- $categoryURL = $category.Page.RelPermalink }}
      {{- else }}
        {{- $categoryURL = printf "/categories/%s/" ($category.CategoryName | urlize) }}
      {{- end }}
      {{/* Check if this category is active by comparing URLs */}}
      {{- $isActive := false }}
      {{- if eq $.Kind "term" }}
        {{- if eq $.RelPermalink $categoryURL }}
          {{- $isActive = true }}
        {{- end }}
      {{- end }}
      {{- $buttonTitle := $category.Page.Title | default $category.CategoryName }}
      {{- if $category.IsEnglish }}
        {{- $buttonTitle = printf "%s [english only]" $buttonTitle }}
      {{- end }}
      {{/* Determine button style based on active state and language */}}
      {{- $buttonClass := "" }}
      {{- if $isActive }}
        {{- if $category.IsEnglish }}
          {{- $buttonClass = "btn-secondary" }}
        {{- else }}
          {{- $buttonClass = "btn-primary" }}
        {{- end }}
      {{- else }}
        {{- if $category.IsEnglish }}
          {{- $buttonClass = "btn-outline-secondary" }}
        {{- else }}
          {{- $buttonClass = "btn-outline-primary" }}
        {{- end }}
      {{- end }}
      {{/* Hide categories with only 1 item behind "Show More" button */}}
      {{- $hiddenClass := "" }}
      {{- if eq $category.Count 1 }}
        {{- $hiddenClass = "category-hidden d-none" }}
        {{- $hasHiddenCategories = true }}
      {{- end }}
      <a href="{{ $categoryURL }}" class="btn {{ $buttonClass }} {{ $hiddenClass }}" title="{{ $buttonTitle }}">
        {{ $category.Page.Title | default $category.CategoryName }}
        <span class="badge {{ if $category.IsEnglish }}bg-secondary{{ else }}bg-primary{{ end }} text-white ms-1">{{ $category.Count }}</span>
      </a>
    {{- end }}

    {{/* Show More button - only if there are hidden categories with count of 1 */}}
    {{- if $hasHiddenCategories }}
      <button id="category-show-more-btn" class="text-primary text-decoration-none border-0 bg-transparent cursor-pointer" onclick="toggleCategories()" style="cursor: pointer;">
        <i class="fa-solid fa-chevron-down me-2"></i>
        <span id="show-more-text">{{ i18n "show_more" | default "Show More" }}</span>
      </button>
    {{- end }}
  </div>
</div>

{{/* JavaScript for show/hide functionality */}}
<script>
  function toggleCategories() {
    const hiddenCategories = document.querySelectorAll('.category-hidden');
    const btn = document.getElementById('category-show-more-btn');
    const btnText = document.getElementById('show-more-text');
    const btnIcon = btn.querySelector('i');
    
    const isExpanded = !hiddenCategories[0].classList.contains('d-none');
    
    hiddenCategories.forEach(category => {
      if (isExpanded) {
        category.classList.add('d-none');
      } else {
        category.classList.remove('d-none');
      }
    });
    
    if (isExpanded) {
      btnText.textContent = '{{ i18n "show_more" | default "Show More" }}';
      btnIcon.classList.remove('fa-chevron-up');
      btnIcon.classList.add('fa-chevron-down');
    } else {
      btnText.textContent = '{{ i18n "show_less" | default "Show Less" }}';
      btnIcon.classList.remove('fa-chevron-down');
      btnIcon.classList.add('fa-chevron-up');
    }
  }
</script>
