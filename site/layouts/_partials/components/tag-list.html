{{/* Tag Filter List */}}
<div class="mb-5">
  <div class="d-flex flex-wrap justify-content-center gap-2">
    {{/* All button (Homepage link) */}}
    <a href="{{ .Site.Home.RelPermalink }}" class="btn {{ if .IsHome }}btn-primary{{ else }}btn-outline-primary{{ end }}">
      <i class="fa-solid fa-grid-2 me-2"></i>
      {{ i18n "all_topics" | default "All" }}
    </a>

    {{/* Build a sorted list of tags by extensions count */}}
    {{- $tagList := slice }}
    {{- $allTags := dict }}
    {{- $defaultSite := index .Site.Sites 0 }}
    {{- $currentLangTags := .Site.Taxonomies.tags }}

    {{/* Always merge tags from default language to show untranslated tags */}}
    {{- range $tagName, $taxonomy := $defaultSite.Taxonomies.tags }}
      {{- $allTags = merge $allTags (dict $tagName $taxonomy) }}
    {{- end }}
    {{/* Then merge current language tags (they override default if they exist) */}}
    {{- range $tagName, $taxonomy := .Site.Taxonomies.tags }}
      {{- $allTags = merge $allTags (dict $tagName $taxonomy) }}
    {{- end }}

    {{- range $tagName, $taxonomy := $allTags }}
      {{/* Count only pages with "extensions" category */}}
      {{- $extensionsCount := 0 }}
      {{- range $taxonomy.Pages }}
        {{- if in .Params.categories "extensions" }}
          {{- $extensionsCount = add $extensionsCount 1 }}
        {{- end }}
      {{- end }}
      {{- if gt $extensionsCount 0 }}
        {{/* Check if this tag is from English (not in current language) */}}
        {{- $isEnglishTag := false }}
        {{- if ne $.Site.Language.Lang $defaultSite.Language.Lang }}
          {{- if not (index $currentLangTags $tagName) }}
            {{- $isEnglishTag = true }}
          {{- end }}
        {{- end }}
        {{- $tagList = $tagList | append (dict "Page" $taxonomy.Page "TagName" $tagName "Count" $extensionsCount "IsEnglish" $isEnglishTag) }}
      {{- end }}
    {{- end }}

    {{/* Sort by count descending */}}
    {{- range sort $tagList "Count" "desc" }}
      {{/* Construct tag URL - fallback to manual construction if page doesn't exist */}}
      {{- $tagURL := "" }}
      {{- if .Page }}
        {{- $tagURL = .Page.RelPermalink }}
      {{- else }}
        {{- $tagURL = printf "/topics/%s/" (.TagName | urlize) }}
      {{- end }}
      {{/* Check if this tag is active by comparing URLs */}}
      {{- $isActive := false }}
      {{- if eq $.Kind "term" }}
        {{- if eq $.RelPermalink $tagURL }}
          {{- $isActive = true }}
        {{- end }}
      {{- end }}
      {{- $buttonTitle := .Page.Title | default .TagName }}
      {{- if .IsEnglish }}
        {{- $buttonTitle = printf "%s [english only]" $buttonTitle }}
      {{- end }}
      {{/* Determine button style based on active state and language */}}
      {{- $buttonClass := "" }}
      {{- if $isActive }}
        {{- if .IsEnglish }}
          {{- $buttonClass = "btn-secondary" }}
        {{- else }}
          {{- $buttonClass = "btn-primary" }}
        {{- end }}
      {{- else }}
        {{- if .IsEnglish }}
          {{- $buttonClass = "btn-outline-secondary" }}
        {{- else }}
          {{- $buttonClass = "btn-outline-primary" }}
        {{- end }}
      {{- end }}
      <a href="{{ $tagURL }}" class="btn {{ $buttonClass }}" title="{{ $buttonTitle }}">
        {{ .Page.Title | default .TagName }}
        <span class="badge {{ if .IsEnglish }}bg-secondary{{ else }}bg-primary{{ end }} text-white ms-1">{{ .Count }}</span>
      </a>
    {{- end }}
  </div>
</div>
